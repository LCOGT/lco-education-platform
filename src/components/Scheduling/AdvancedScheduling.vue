<script setup>
import { ref, onMounted, nextTick } from 'vue'
import SchedulingSettings from './SchedulingSettings.vue'
import ProposalDropdown from '../Global/ProposalDropdown.vue'
import Calendar from './Calendar.vue'
import { useProposalStore } from '../../stores/proposalManagement.js'

const proposalStore = useProposalStore()

const targetsData = ref([])
const startDate = ref('')
const endDate = ref('')
const selectedProposal = ref('')
const selectedObject = ref('')
const step = ref(1)

const emits = defineEmits(['selectionsComplete'])

const handleProposalSelection = (proposal) => {
  // Only advance step if still on step 1
  if (step.value === 1) {
    selectedProposal.value = proposal
    step.value = 2 // Move to the next step
  } else {
    // Just update the proposal without advancing steps
    selectedProposal.value = proposal
  }
}

const handleTargetUpdate = (targetUpdate) => {
  // If an index was passed and it exists in targetsData, update that entry.
  if (targetsData.value[targetUpdate.index]) {
    targetsData.value[targetUpdate.index] = {
      ...targetsData.value[targetUpdate.index],
      name: targetUpdate.name,
      ra: targetUpdate.ra,
      dec: targetUpdate.dec,
      simbadResponse: selectedObject.value === 'nonsidereal' ? targetUpdate.simbadResponse : {}
    }
  } else {
    // Fallback: look for an existing target with the same name and update it.
    const existingTarget = targetsData.value.find(t => t.name === targetUpdate.name)
    if (existingTarget) {
      existingTarget.ra = targetUpdate.ra
      existingTarget.dec = targetUpdate.dec
      existingTarget.simbadResponse = selectedObject.value === 'nonsidereal' ? targetUpdate.simbadResponse : {}
    } else {
      // If no match, push a new target.
      targetsData.value.push({
        ...targetUpdate,
        exposures: []
      })
    }
  }
  emitSelections()
}

const handleExposuresUpdate = (exposures) => {
  // Use nextTick to wait for target update
  nextTick(() => {
    const activeTarget = targetsData.value[targetsData.value.length - 1]
    if (activeTarget) {
      activeTarget.exposures = exposures
    } else {
      return
    }
    emitSelections()
  })
}

const handleDateRangeUpdate = (dateRange) => {
  startDate.value = dateRange.start.toISOString().split('T')[0]
  endDate.value = dateRange.end.toISOString().split('T')[0]
  emitSelections()
  step.value = 4
}

const emitSelections = () => {
  const payload = {
    targets: targetsData.value,
    startDate: startDate.value,
    endDate: endDate.value,
    proposal: selectedProposal.value,
    objectType: selectedObject.value
  }

  const isComplete =
    step.value === 5 &&
    targetsData.value.length > 0 &&
    startDate.value &&
    endDate.value &&
    selectedProposal.value &&
    targetsData.value.every(target => target.exposures.length > 0)

  emits('selectionsComplete', { ...payload, complete: isComplete })
}

const hasManyProposals = () => {
  return proposalStore.proposalsWithNormalTimeAllocation.length > 1
}

const handleDisplay = (display) => {
  step.value = display
  emitSelections()
  emits('updateDisplay', display)
}

const handleObjectSelection = (object) => {
  selectedObject.value = object
  step.value = 3
  emitSelections()
}

onMounted(() => {
  if (proposalStore.proposalsWithNormalTimeAllocation.length === 1) {
    selectedProposal.value = proposalStore.proposalsWithNormalTimeAllocation[0].id
    step.value = 2
  }
})
</script>

<template>
  <ProposalDropdown v-if="hasManyProposals && step === 1" :isItRealTime="false" @selectionsComplete="handleProposalSelection"/>
  <div v-if="step === 2" class="field is-horizontal">
    <div class="button" @click="handleObjectSelection('nonsidereal')">Solar System Object</div>
    <div class="button" @click="handleObjectSelection('sidereal')">Outer Space Object</div>
  </div>
  <Calendar @updateDateRange="handleDateRangeUpdate" v-if="step === 3"/>
  <SchedulingSettings v-if="selectedProposal && step >= 4"
    :show-project-field="true"
    :show-title-field="true"
    :start-date="startDate"
    :end-date="endDate"
    :object-type="selectedObject"
    @targetUpdated="handleTargetUpdate"
    @exposuresUpdated="handleExposuresUpdate"
    @updateDisplay="handleDisplay"
  />
</template>

<style scoped>

.p-text {
  margin-right: 1em;
  font-size: 1.2em;
  cursor: default;
}
.scheduling-inputs {
  padding: 0.5em;
  box-sizing: border-box;
  border: 1px solid gray;
  border-radius: 0.2em;
}
</style>
